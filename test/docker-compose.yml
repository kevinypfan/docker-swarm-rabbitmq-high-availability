version: "3.8"
services:
  consul-server:
    image: consul:1.15
    command: >
      agent
      -server
      -ui
      -bootstrap-expect=3
      -client=0.0.0.0
      -retry-join=tasks.consul-server
      -datacenter=dc1
      -data-dir=/consul/data
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    networks:
      - consul-net
    volumes:
      - consul_data:/consul/data
    deploy:
      replicas: 3
      placement:
        max_replicas_per_node: 1 
        constraints:
          - node.role == manager
    ports:
      - target: 8500
        published: 3001
        protocol: tcp
        mode: host  # 使用 host 模式避免網路問題
      - target: 8600
        published: 8600
        protocol: udp
        mode: host
      - target: 8301
        published: 8301
        protocol: udp
        mode: host  # Serf LAN 端口
      - target: 8302
        published: 8302
        protocol: udp
        mode: host  # Serf WAN 端口
      - target: 8300
        published: 8300
        protocol: tcp
        mode: host  # RPC 端口

networks:
  consul-net:

volumes:
  consul_data:
